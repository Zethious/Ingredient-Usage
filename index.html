<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SnowFruit Ingredient Usage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Optional: silence favicon 404 -->
  <link rel="icon" href="data:,">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, #1b2a4a 0%, #0b1220 60%);
      color: #eaf0ff;
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 28px; }
    h1 { margin: 0 0 6px; font-size: 34px; }
    .sub { color: #9fb0d0; margin-bottom: 20px; }

    .card {
      background: rgba(20,30,55,.85);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      font-size: 14px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f5c451;
    }
    .dot.ok { background: #3ddc84; }
    .dot.bad { background: #ff5c5c; }

    .upload-box {
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 16px;
      margin-top: 12px;
    }

    button {
      padding: 10px 16px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg,#2e6bff,#4dd0ff);
      color: #06122b;
      margin-right: 10px;
    }

    button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 12px;
      margin-top: 14px;
    }

    .stat {
      background: rgba(255,255,255,.05);
      border-radius: 12px;
      padding: 12px;
      font-size: 14px;
    }

    .note { margin-top: 10px; color: #9fb0d0; }
    .err { color: #ff9b9b; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="header-row">
    <div>
      <h1>SnowFruit Ingredient Usage</h1>
      <div class="sub">
        Master is built-in. Upload your weekly sales report (.xlsx) and click Run.
      </div>
    </div>

    <div class="pill">
      <span id="libDot" class="dot"></span>
      <span id="libText">SheetJS: loading…</span>
    </div>
  </div>

  <div class="card">
    <strong>Upload Weekly Sales</strong>
    <div class="note">Required columns: Date, GTIN, QS</div>

    <div class="upload-box">
      <input id="salesFile" type="file" accept=".xlsx" />
      <div class="note">
        XLSX parsing loads from your site (no CDNs):
        <code>/Ingredient-Usage/vendor/xlsx.full.min.js</code>
      </div>
    </div>

    <div style="margin-top:14px">
      <button id="runBtn" disabled>Run report</button>
    </div>

    <div class="stats">
      <div class="stat">Sales rows loaded<br><strong id="rows">—</strong></div>
      <div class="stat">Items matched<br><strong id="matched">—</strong></div>
      <div class="stat">Undefined items<br><strong id="undefined">—</strong></div>
    </div>

    <div id="statusText" class="note">Loading SheetJS…</div>
  </div>

  <div class="card">
    <strong>Results</strong>
    <div class="note">Ingredient totals + biggest missing items.</div>
    <div class="note">No results yet</div>
  </div>
</div>

<!-- ===== SheetJS (LOCAL, PROJECT PATH) ===== -->
<script
  src="/Ingredient-Usage/vendor/xlsx.full.min.js"
  onload="onXLSXLoaded()"
  onerror="onXLSXFailed()">
</script>

<script>
  const runBtn = document.getElementById("runBtn");
  const libDot = document.getElementById("libDot");
  const libText = document.getElementById("libText");
  const statusText = document.getElementById("statusText");

  function onXLSXLoaded() {
    libDot.classList.add("ok");
    libText.textContent = "SheetJS: local OK";
    statusText.textContent = "Ready. Choose a sales report and click Run.";
    runBtn.disabled = false;
  }

  function onXLSXFailed() {
    libDot.classList.add("bad");
    libText.textContent = "SheetJS: failed";
    statusText.innerHTML =
      '<span class="err">Could not load SheetJS from /Ingredient-Usage/vendor/xlsx.full.min.js</span>';
  }

  runBtn.addEventListener("click", async () => {
    const file = document.getElementById("salesFile").files[0];
    if (!file) {
      statusText.innerHTML = '<span class="err">Please choose a sales file.</span>';
      return;
    }

    try {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      document.getElementById("rows").textContent =
        XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]).length;
      statusText.textContent = "Sales file loaded successfully.";
    } catch (e) {
      statusText.innerHTML = `<span class="err">${e.message}</span>`;
    }
  });
</script>

</body>
</html>
