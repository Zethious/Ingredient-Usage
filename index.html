<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SnowFruit Ingredient Usage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">

  <!-- ✅ LOCAL SheetJS (this is the fix) -->
  <script src="./vendor/xlsx.full.min.js"></script>

  <style>
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(110,231,255,.13), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(167,139,250,.12), transparent 60%),
        linear-gradient(180deg,#0b1220,#070b14);
      color:#eaf0ff;
    }
    .wrap{max-width:1100px;margin:auto;padding:28px}
    h1{margin:0;font-size:32px}
    .sub{color:#9fb0d0;margin-top:6px}

    .pill{
      float:right;
      border:1px solid rgba(255,255,255,.15);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      background:rgba(255,255,255,.05)
    }

    .card{
      margin-top:18px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:18px;
    }

    .upload{
      border:1px dashed rgba(255,255,255,.35);
      border-radius:14px;
      padding:14px;
      margin-top:12px;
    }

    button{
      margin-top:12px;
      padding:10px 16px;
      border-radius:12px;
      border:1px solid rgba(110,231,255,.45);
      background:rgba(110,231,255,.18);
      color:white;
      font-weight:700;
      cursor:pointer;
    }

    button:disabled{opacity:.4}

    .stats{
      display:flex;
      gap:12px;
      margin-top:12px;
    }
    .stat{
      flex:1;
      background:rgba(0,0,0,.25);
      border-radius:14px;
      padding:12px;
    }
    .k{font-size:12px;color:#9fb0d0}
    .v{font-size:18px;font-weight:800}

    table{
      width:100%;
      margin-top:14px;
      border-collapse:collapse;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.1);
      text-align:left;
    }
    th{color:#cfe0ff;font-size:12px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="pill" id="statusPill">SheetJS: checking…</div>
  <h1>SnowFruit Ingredient Usage</h1>
  <div class="sub">Master is built-in. Upload your weekly sales report (.xlsx) and click Run.</div>

  <div class="card">
    <h3>Upload Weekly Sales</h3>
    <div class="sub">Required columns: Date, GTIN, QS</div>

    <div class="upload">
      <input type="file" id="file" accept=".xlsx">
    </div>

    <button id="runBtn" disabled>Run report</button>

    <div class="stats">
      <div class="stat"><div class="k">Sales rows loaded</div><div class="v" id="rows">—</div></div>
      <div class="stat"><div class="k">Items matched</div><div class="v" id="matched">—</div></div>
      <div class="stat"><div class="k">Undefined items</div><div class="v" id="undef">—</div></div>
    </div>

    <div class="sub" id="note">Waiting for SheetJS…</div>
  </div>

  <div class="card">
    <h3>Results</h3>
    <div id="results">No results yet</div>
  </div>

</div>

<script>
/* ---------- SheetJS status ---------- */
const pill = document.getElementById("statusPill");
const runBtn = document.getElementById("runBtn");
const note = document.getElementById("note");

if (window.XLSX) {
  pill.textContent = "SheetJS: local OK";
  runBtn.disabled = false;
  note.textContent = "Ready.";
} else {
  pill.textContent = "SheetJS: failed";
  note.textContent = "xlsx.full.min.js did not load.";
}

/* ---------- Run report ---------- */
runBtn.onclick = async () => {
  const f = document.getElementById("file").files[0];
  if (!f) return;

  const buf = await f.arrayBuffer();
  const wb = XLSX.read(buf, { type: "array" });
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

  document.getElementById("rows").textContent = rows.length;

  const gtinKey = Object.keys(rows[0]).find(k => k.toLowerCase()==="gtin");
  const qsKey   = Object.keys(rows[0]).find(k => k.toLowerCase()==="qs");

  if (!gtinKey || !qsKey) {
    note.textContent = "Missing GTIN or QS column.";
    return;
  }

  const map = {};
  rows.forEach(r=>{
    if (!r[gtinKey]) return;
    map[r[gtinKey]] = (map[r[gtinKey]]||0) + Number(r[qsKey]||0);
  });

  document.getElementById("matched").textContent = Object.keys(map).length;
  document.getElementById("undef").textContent = 0;

  let html = "<table><tr><th>GTIN</th><th>Units Sold</th></tr>";
  Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([g,q])=>{
      html += `<tr><td>${g}</td><td>${q}</td></tr>`;
    });
  html += "</table>";

  document.getElementById("results").innerHTML = html;
};
</script>
</body>
</html>
