<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SnowFruit Inventory Estimator</title>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1526;
      --text:#eaf0ff;
      --muted:#9fb0d0;
      --border:rgba(255,255,255,.10);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% 0%, rgba(110,231,255,.13), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(167,139,250,.12), transparent 60%),
                  linear-gradient(180deg, var(--bg), #070b14);
      color:var(--text);
      min-height:100vh;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px;
    }
    .title{
      display:flex;flex-direction:column;gap:6px;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;line-height:1.35}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;
      color:var(--muted);font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 8px;font-size:15px;
    }
    .card p{margin:0;color:var(--muted);font-size:13px;line-height:1.45}

    .uploader{
      margin-top:12px;
      border: 1px dashed rgba(255,255,255,.25);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .uploader .left{
      display:flex;flex-direction:column;gap:6px;
    }
    .uploader .label{font-size:13px}
    .uploader .hint{font-size:12px;color:var(--muted)}
    input[type="file"]{
      color:var(--muted);
      max-width: 100%;
    }

    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      appearance:none;border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:600;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border .2s ease;
      font-size:13px;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button:active{transform:translateY(1px)}
    button.primary{
      border:1px solid rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.18), rgba(167,139,250,.14));
    }
    button.danger{
      border:1px solid rgba(251,113,133,.35);
      background: rgba(251,113,133,.12);
    }

    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

    .stats{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
    }
    .stat{
      border:1px solid var(--border);
      background: rgba(0,0,0,.15);
      padding:10px 12px;border-radius:14px;
      min-width:180px;
    }
    .stat .k{font-size:11px;color:var(--muted);margin-bottom:4px}
    .stat .v{font-size:16px;font-weight:800}

    .tabs{
      margin-top:16px;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(110,231,255,.35);
      background: rgba(110,231,255,.10);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:12px;
      text-align:left;
    }
    th{
      color:#cfe0ff;
      font-size:11px;
      letter-spacing:.5px;
      text-transform:uppercase;
      background: rgba(255,255,255,.04);
    }
    tr:hover td{background: rgba(255,255,255,.03)}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--muted);
    }
    .badge.good{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12);color:#caffe8}
    .badge.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12);color:#ffe8b0}
    .badge.bad{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.12);color:#ffd0da}

    .note{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .footer{
      margin-top:18px;color:var(--muted);font-size:12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>SnowFruit Inventory Estimator</h1>
        <div class="sub">
          Upload your weekly sales report to calculate ingredient ounces + exact/rounded case usage.
          Master sheet is stored locally in your browser (no server).
        </div>
      </div>

      <div class="pill" id="masterStatusPill">
        <span class="dot" id="masterDot"></span>
        <span id="masterStatusText">Master: not loaded</span>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>1) Load Master Sheet (one-time)</h2>
        <p>Upload your AI master sheet. We’ll store it in your browser so next time you only upload sales.</p>

        <div class="uploader">
          <div class="left">
            <div class="label">Master sheet (.xlsx)</div>
            <div class="hint">Expected tabs: <span class="mono">Items</span>, <span class="mono">Recipes</span>, <span class="mono">Ingredients</span></div>
          </div>
          <input type="file" id="masterFile" accept=".xlsx"/>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="primary" id="saveMasterBtn">Save master locally</button>
          <button class="danger" id="clearMasterBtn">Clear saved master</button>
        </div>

        <div class="note" id="masterNote"></div>
      </div>

      <div class="card">
        <h2>2) Upload Weekly Sales Report</h2>
        <p>Upload your weekly sales export. We’ll compute ingredient usage immediately.</p>

        <div class="uploader">
          <div class="left">
            <div class="label">Sales report (.xlsx)</div>
            <div class="hint">Needs columns: <span class="mono">Date</span>, <span class="mono">GTIN</span>, <span class="mono">QS</span> (like your Kroger export)</div>
          </div>
          <input type="file" id="salesFile" accept=".xlsx"/>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="primary" id="runBtn">Run report</button>
          <button id="downloadCsvBtn">Download ingredient CSV</button>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="k">Sales rows loaded</div>
            <div class="v" id="rowsCount">—</div>
          </div>
          <div class="stat">
            <div class="k">Items matched to master</div>
            <div class="v" id="matchedCount">—</div>
          </div>
          <div class="stat">
            <div class="k">Undefined items</div>
            <div class="v" id="undefinedCount">—</div>
          </div>
        </div>

        <div class="note" id="runNote"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 4px">Results</h2>
          <p style="margin:0">Ingredient totals (oz + cases). Plus “undefined items” that still need recipes.</p>
        </div>
        <span class="badge" id="resultsBadge">No results yet</span>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="ingredients">Ingredient cases used</div>
        <div class="tab" data-tab="undefined">Top undefined items</div>
        <div class="tab" data-tab="pineapple">Pineapple daily sanity check</div>
      </div>

      <div id="tab-ingredients"></div>
      <div id="tab-undefined" style="display:none"></div>
      <div id="tab-pineapple" style="display:none"></div>

      <div class="footer">
        Tip: If totals look low, check the <span class="mono">Top undefined items</span> tab — those contribute <b>zero</b> until recipes exist.
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const LS_KEY = "snowfruit_master_v1";

    function normalizeUpc(v){
      if (v === null || v === undefined) return "";
      let s = String(v).trim();
      s = s.replace(/\.0+$/,"");
      // Scientific notation guard
      if (/e\+?/i.test(s)){
        const num = Number(s);
        if (!Number.isNaN(num)) return String(Math.round(num));
      }
      // If numeric-ish, make integer string
      if (/^\d+(\.\d+)?$/.test(s)){
        const num = Number(s);
        if (!Number.isNaN(num)) return String(Math.round(num));
      }
      return s;
    }

    function toNumber(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function fmt(n, d=2){
      if (!Number.isFinite(n)) return "—";
      return n.toLocaleString(undefined, {maximumFractionDigits:d});
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function sheetToJson(workbook, sheetName){
      const ws = workbook.Sheets[sheetName];
      if (!ws) return null;
      return XLSX.utils.sheet_to_json(ws, {defval: ""});
    }

    // ---------- State ----------
    let masterWorkbook = null;
    let masterData = null; // { items, recipes, ingredients, lookups }
    let salesWorkbook = null;
    let lastIngredientRows = []; // for CSV download

    const masterDot = document.getElementById("masterDot");
    const masterStatusText = document.getElementById("masterStatusText");
    const masterNote = document.getElementById("masterNote");
    const resultsBadge = document.getElementById("resultsBadge");

    const rowsCount = document.getElementById("rowsCount");
    const matchedCount = document.getElementById("matchedCount");
    const undefinedCount = document.getElementById("undefinedCount");
    const runNote = document.getElementById("runNote");

    // ---------- UI: Tabs ----------
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        const tab = t.dataset.tab;
        ["ingredients","undefined","pineapple"].forEach(name => {
          document.getElementById("tab-"+name).style.display = (name===tab) ? "block" : "none";
        });
      });
    });

    // ---------- Master load/save ----------
    async function readFileAsArrayBuffer(file){
      return await file.arrayBuffer();
    }

    function buildMasterModel(items, recipes, ingredients){
      // Items lookup by upc
      const itemByUpc = new Map();
      // Multiple rows can exist per UPC. We'll pick best match later using exact name if needed.
      for (const r of items){
        const upc = normalizeUpc(r.upc_gtin ?? r.UPC ?? r["UPC/GTIN"] ?? "");
        if (!upc) continue;
        const row = {
          item_id: String(r.item_id || "").trim(),
          item_name: String(r.item_name || r["Item Name"] || "").trim(),
          upc_gtin: upc
        };
        if (!itemByUpc.has(upc)) itemByUpc.set(upc, []);
        itemByUpc.get(upc).push(row);
      }

      // Recipes lookup by item_id
      const recipeByItem = new Map();
      for (const r of recipes){
        const item_id = String(r.item_id || "").trim();
        if (!item_id) continue;
        if (!recipeByItem.has(item_id)) recipeByItem.set(item_id, []);
        recipeByItem.get(item_id).push({
          ingredient_id: String(r.ingredient_id || "").trim(),
          ingredient_name: String(r.ingredient_name || "").trim(),
          ingredient_oz: Number(r.ingredient_oz)
        });
      }

      // Ingredients lookup by ingredient_id
      const ingById = new Map();
      for (const r of ingredients){
        const iid = String(r.ingredient_id || "").trim();
        if (!iid) continue;
        ingById.set(iid, {
          ingredient_name: String(r.ingredient_name || "").trim(),
          edible_oz_per_case: Number(r.edible_oz_per_case)
        });
      }

      return { items, recipes, ingredients, itemByUpc, recipeByItem, ingById };
    }

    function setMasterStatus(ok, msg){
      masterDot.classList.toggle("good", ok);
      masterDot.classList.toggle("bad", !ok);
      masterStatusText.textContent = msg;
    }

    function loadMasterFromLocalStorage(){
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) {
        setMasterStatus(false, "Master: not loaded");
        masterNote.textContent = "Upload your master sheet and click “Save master locally”.";
        return;
      }
      try{
        const parsed = JSON.parse(raw);
        masterData = buildMasterModel(parsed.Items, parsed.Recipes, parsed.Ingredients);
        setMasterStatus(true, "Master: loaded (saved)");
        masterNote.textContent = "Master loaded from this browser’s local storage. You can now upload sales anytime.";
      }catch(e){
        setMasterStatus(false, "Master: failed to load");
        masterNote.textContent = "Saved master looks corrupted. Clear and re-upload.";
      }
    }

    loadMasterFromLocalStorage();

    document.getElementById("masterFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const buf = await readFileAsArrayBuffer(file);
      masterWorkbook = XLSX.read(buf, {type:"array"});

      const Items = sheetToJson(masterWorkbook, "Items");
      const Recipes = sheetToJson(masterWorkbook, "Recipes");
      const Ingredients = sheetToJson(masterWorkbook, "Ingredients");

      if (!Items || !Recipes || !Ingredients){
        setMasterStatus(false, "Master: missing tabs");
        masterNote.textContent = "Master must contain tabs named: Items, Recipes, Ingredients.";
        return;
      }

      masterData = buildMasterModel(Items, Recipes, Ingredients);
      setMasterStatus(true, "Master: loaded (not saved)");
      masterNote.textContent = `Loaded master from file: ${file.name}. Click “Save master locally” to persist it for future use.`;
    });

    document.getElementById("saveMasterBtn").addEventListener("click", () => {
      if (!masterWorkbook){
        masterNote.textContent = "Upload a master sheet first.";
        return;
      }
      const Items = sheetToJson(masterWorkbook, "Items");
      const Recipes = sheetToJson(masterWorkbook, "Recipes");
      const Ingredients = sheetToJson(masterWorkbook, "Ingredients");

      localStorage.setItem(LS_KEY, JSON.stringify({Items, Recipes, Ingredients}));
      setMasterStatus(true, "Master: loaded (saved)");
      masterNote.textContent = "Saved! This browser will remember your master sheet.";
    });

    document.getElementById("clearMasterBtn").addEventListener("click", () => {
      localStorage.removeItem(LS_KEY);
      masterWorkbook = null;
      masterData = null;
      setMasterStatus(false, "Master: not loaded");
      masterNote.textContent = "Cleared saved master. Upload it again to run reports.";
    });

    // ---------- Sales load ----------
    document.getElementById("salesFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const buf = await readFileAsArrayBuffer(file);
      salesWorkbook = XLSX.read(buf, {type:"array"});
      runNote.textContent = `Loaded sales file: ${file.name}. Click “Run report”.`;
    });

    // ---------- Core compute ----------
    function pickBestItemForUpc(upc, salesName){
      const candidates = masterData.itemByUpc.get(upc) || [];
      if (candidates.length === 0) return null;
      if (candidates.length === 1) return candidates[0];

      const s = (salesName || "").trim().toLowerCase();
      let best = candidates[0];
      let bestScore = -1;

      for (const c of candidates){
        const n = (c.item_name || "").trim().toLowerCase();
        let score = 0;
        if (n === s) score = 100;
        else if (n.includes(s) || s.includes(n)) score = 80;
        else {
          const st = new Set(s.split(/\s+/).filter(Boolean));
          const nt = new Set(n.split(/\s+/).filter(Boolean));
          const inter = [...st].filter(x => nt.has(x)).length;
          const uni = new Set([...st, ...nt]).size || 1;
          score = Math.floor(60 * inter / uni);
        }
        if (score > bestScore){
          bestScore = score;
          best = c;
        }
      }
      return best;
    }

    function renderTable(containerId, columns, rows, options={}){
      const el = document.getElementById(containerId);
      if (!rows || rows.length === 0){
        el.innerHTML = `<div class="note">No rows.</div>`;
        return;
      }

      const maxRows = options.maxRows ?? rows.length;
      const displayRows = rows.slice(0, maxRows);

      let html = `<table><thead><tr>`;
      for (const col of columns){
        html += `<th class="${col.align==='right'?'right':''}">${col.label}</th>`;
      }
      html += `</tr></thead><tbody>`;

      for (const r of displayRows){
        html += `<tr>`;
        for (const col of columns){
          let v = r[col.key];
          if (col.format) v = col.format(v, r);
          html += `<td class="${col.align==='right'?'right':''}">${v}</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody></table>`;

      if (rows.length > maxRows){
        html += `<div class="note">Showing top ${maxRows} of ${rows.length} rows.</div>`;
      }

      el.innerHTML = html;
    }

    function computeReport(){
      if (!masterData){
        runNote.textContent = "Load your master sheet first.";
        return;
      }
      if (!salesWorkbook){
        runNote.textContent = "Upload a sales report first.";
        return;
      }

      // Assume first sheet
      const firstSheetName = salesWorkbook.SheetNames[0];
      const salesRows = XLSX.utils.sheet_to_json(salesWorkbook.Sheets[firstSheetName], {defval:""});

      // Validate minimal columns
      const hasGTIN = salesRows.some(r => r.GTIN !== undefined || r["GTIN"] !== undefined);
      const hasQS = salesRows.some(r => r.QS !== undefined || r["QS"] !== undefined);
      const hasDate = salesRows.some(r => r.Date !== undefined || r["Date"] !== undefined);

      if (!hasGTIN || !hasQS){
        runNote.textContent = "Sales file missing required columns (GTIN, QS).";
        return;
      }

      // Aggregate units sold by UPC (and keep first product name)
      const byUpc = new Map();
      const byDateUpc = new Map(); // for pineapple daily

      for (const r of salesRows){
        const upc = normalizeUpc(r.GTIN ?? r["GTIN"] ?? "");
        if (!upc) continue;
        const qs = toNumber(r.QS ?? r["QS"] ?? 0);
        const name = String(r["Product name"] ?? r["Product Name"] ?? r.Product ?? r["Product"] ?? "");
        const date = r.Date ?? r["Date"] ?? "";

        if (!byUpc.has(upc)){
          byUpc.set(upc, {upc, units:0, name});
        }
        byUpc.get(upc).units += qs;
        if (name && !byUpc.get(upc).name) byUpc.get(upc).name = name;

        // date-upc for daily pineapple
        const dkey = String(date);
        const key = dkey + "||" + upc;
        if (!byDateUpc.has(key)){
          byDateUpc.set(key, {date:dkey, upc, units:0, name});
        }
        byDateUpc.get(key).units += qs;
      }

      const upcRows = Array.from(byUpc.values());
      rowsCount.textContent = String(salesRows.length);

      // Match items + expand to ingredients
      let matched = 0;
      const undefinedItems = []; // items with no usable recipes
      const ingredientTotals = new Map(); // ingredient_id -> total oz

      // Pineapple daily
      let pineappleId = null;
      let pineappleCaseOz = null;
      for (const [iid, info] of masterData.ingById.entries()){
        if ((info.ingredient_name || "").toLowerCase() === "pineapple"){
          pineappleId = iid;
          pineappleCaseOz = info.edible_oz_per_case;
          break;
        }
      }
      const pineappleDailyOz = new Map(); // date -> oz

      for (const row of upcRows){
        const bestItem = pickBestItemForUpc(row.upc, row.name);
        if (!bestItem){
          undefinedItems.push({name: row.name || "(unknown)", upc: row.upc, units: row.units, reason:"Not in master (UPC missing)"});
          continue;
        }
        matched++;

        const recipe = masterData.recipeByItem.get(bestItem.item_id) || [];
        // usable lines
        const usable = recipe.filter(x =>
          x.ingredient_id && x.ingredient_id !== "TO_DEFINE" &&
          Number.isFinite(x.ingredient_oz) && x.ingredient_oz > 0
        );

        if (usable.length === 0){
          undefinedItems.push({name: bestItem.item_name || row.name || "(unknown)", upc: row.upc, units: row.units, reason:"No recipe / TO_DEFINE"});
          continue;
        }

        // Accumulate ingredient totals
        for (const line of usable){
          const oz = row.units * line.ingredient_oz;
          ingredientTotals.set(line.ingredient_id, (ingredientTotals.get(line.ingredient_id) || 0) + oz);
        }
      }

      matchedCount.textContent = String(matched);
      undefinedCount.textContent = String(undefinedItems.length);

      // Build ingredient rows
      const ingredientRows = [];
      for (const [iid, totalOz] of ingredientTotals.entries()){
        const ing = masterData.ingById.get(iid);
        const caseOz = ing?.edible_oz_per_case;
        const casesExact = (Number.isFinite(caseOz) && caseOz > 0) ? (totalOz / caseOz) : NaN;
        ingredientRows.push({
          ingredient_id: iid,
          ingredient_name: ing?.ingredient_name || iid,
          total_oz: totalOz,
          edible_oz_per_case: caseOz,
          cases_exact: casesExact,
          cases_rounded: Number.isFinite(casesExact) ? Math.ceil(casesExact) : ""
        });
      }
      ingredientRows.sort((a,b) => (b.cases_exact||0) - (a.cases_exact||0));

      // Prepare undefined top list
      undefinedItems.sort((a,b) => b.units - a.units);

      // Pineapple daily sanity check (only if we can compute it)
      const pineappleDaily = [];
      if (pineappleId && pineappleCaseOz && pineappleCaseOz > 0){
        // build daily from date-upc map using recipes for pineapple only
        for (const v of byDateUpc.values()){
          const bestItem = pickBestItemForUpc(v.upc, v.name);
          if (!bestItem) continue;
          const recipe = masterData.recipeByItem.get(bestItem.item_id) || [];
          const pineLine = recipe.find(x => x.ingredient_id === pineappleId && Number.isFinite(x.ingredient_oz) && x.ingredient_oz > 0);
          if (!pineLine) continue;
          const oz = v.units * pineLine.ingredient_oz;
          const d = v.date || "(blank date)";
          pineappleDailyOz.set(d, (pineappleDailyOz.get(d) || 0) + oz);
        }
        for (const [date, oz] of pineappleDailyOz.entries()){
          pineappleDaily.push({
            date,
            pineapple_oz: oz,
            pineapple_cases: oz / pineappleCaseOz
          });
        }
        pineappleDaily.sort((a,b) => String(a.date).localeCompare(String(b.date)));
      }

      // Render
      const badgeType = undefinedItems.length === 0 ? "good" : (undefinedItems.length < 10 ? "warn" : "bad");
      resultsBadge.className = "badge " + badgeType;
      resultsBadge.textContent = `Computed ${ingredientRows.length} ingredients • Undefined items: ${undefinedItems.length}`;

      renderTable("tab-ingredients", [
        {key:"ingredient_name", label:"Ingredient"},
        {key:"total_oz", label:"Total oz", align:"right", format:v=>fmt(v,1)},
        {key:"edible_oz_per_case", label:"Edible oz/case", align:"right", format:v=>fmt(v,1)},
        {key:"cases_exact", label:"Cases (exact)", align:"right", format:v=>fmt(v,3)},
        {key:"cases_rounded", label:"Cases (rounded)", align:"right", format:v=>fmt(v,0)},
      ], ingredientRows, {maxRows: 200});

      renderTable("tab-undefined", [
        {key:"name", label:"Product"},
        {key:"upc", label:"GTIN"},
        {key:"units", label:"Units sold", align:"right", format:v=>fmt(v,0)},
        {key:"reason", label:"Why missing"},
      ], undefinedItems, {maxRows: 60});

      if (pineappleDaily.length === 0){
        document.getElementById("tab-pineapple").innerHTML =
          `<div class="note">No pineapple daily breakdown available (either pineapple ingredient missing, yields missing, or recipes don’t include pineapple lines).</div>`;
      }else{
        renderTable("tab-pineapple", [
          {key:"date", label:"Date"},
          {key:"pineapple_oz", label:"Pineapple oz", align:"right", format:v=>fmt(v,0)},
          {key:"pineapple_cases", label:"Pineapple cases", align:"right", format:v=>fmt(v,2)},
        ], pineappleDaily, {maxRows: 40});

        const totalCases = pineappleDaily.reduce((s,r)=>s + (r.pineapple_cases||0), 0);
        document.getElementById("tab-pineapple").insertAdjacentHTML("beforeend",
          `<div class="note"><b>Week pineapple total:</b> ${fmt(totalCases,2)} cases (based on recipes × sales × yield)</div>`
        );
      }

      // Save for CSV
      lastIngredientRows = ingredientRows;

      // Notes
      if (undefinedItems.length > 0){
        runNote.innerHTML = `Computed results, but <b>${undefinedItems.length}</b> items are undefined (missing recipe or not in master). Those contribute <b>0</b> until defined.`;
      }else{
        runNote.textContent = "Computed results successfully. No undefined items found.";
      }
    }

    document.getElementById("runBtn").addEventListener("click", computeReport);

    document.getElementById("downloadCsvBtn").addEventListener("click", () => {
      if (!lastIngredientRows || lastIngredientRows.length === 0){
        runNote.textContent = "Run a report first, then download CSV.";
        return;
      }
      const header = ["ingredient_name","total_oz","edible_oz_per_case","cases_exact","cases_rounded"];
      const lines = [header.join(",")];
      for (const r of lastIngredientRows){
        const row = [
          `"${String(r.ingredient_name).replaceAll('"','""')}"`,
          r.total_oz,
          r.edible_oz_per_case ?? "",
          r.cases_exact ?? "",
          r.cases_rounded ?? ""
        ];
        lines.push(row.join(","));
      }
      downloadText("ingredient_cases_used.csv", lines.join("\n"));
    });
  </script>
</body>
</html>
